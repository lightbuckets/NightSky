<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Pocket Planetarium ‚Äî v1.14.13 (Planets + Constellations + Meteor Panel Fix)</title>
<style>
:root{ --bg:#040816; --ink:#eaf2ff; --muted:#a9c2ff; --edge:#1b2d6a; --panel:#0a1240; --accent:#7ee7ff; --warn:#ffd36e; --ok:#a4ffcc; --pad:14px; }
html,body{height:100%;margin:0;background:var(--bg);color:#eaf2ff;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;overflow:hidden}
#app{height:100vh;display:grid;grid-template-rows:64px 1fr 180px;grid-template-columns:420px 1fr;gap:12px;padding:var(--pad);box-sizing:border-box}
header{grid-column:1/-1;display:flex;align-items:center;gap:10px;min-height:64px}
#brand{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:12px;background:linear-gradient(180deg,#09133b,#08112e);border:1px solid var(--edge)}
#logo{width:32px;height:32px;border-radius:50%;background:radial-gradient(circle at 30% 30%, #b8fff7 0%, #6dd3ff 40%, #2a4bff 60%, #001637 72%)}
h1{font-size:18px;margin:0}
.badge{display:inline-flex;align-items:center;gap:6px;padding:.24rem .5rem;border-radius:999px;background:#0b1848;border:1px solid #1a2f69;color:#b9c2ff;font-size:11px}
.pill{display:inline-flex;align-items:center;gap:6px;padding:.22rem .5rem;border:1px solid #2441a0;border-radius:999px;color:#cde0ff;background:#0a1540cc;font-size:11px}
#left{grid-row:2/4;grid-column:1;background:linear-gradient(180deg,#0b154a,#0a1340 60%,#09102f); border:1px solid var(--edge); border-radius:14px; padding:10px; overflow:auto}
#canvasWrap{grid-row:2;grid-column:2;position:relative;border-radius:14px;overflow:hidden;border:1px solid var(--edge);background: radial-gradient(900px 650px at 50% 50%, #050b1a 0%, #050a17 70%, #04070c 100%); min-height:0}
#sky{width:100%;height:100%;display:block;cursor:grab}
#overlay{position:absolute;inset:0;pointer-events:none}
#bottom{grid-row:3;grid-column:2;display:grid;grid-template-rows:auto auto;gap:8px;align-items:center;background:linear-gradient(180deg,#0a1338 0,#0b1230 100%);border:1px solid var(--edge);border-radius:14px;padding:12px;min-height:0}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:.3rem 0}
details{border:1px solid var(--edge); border-radius:12px; background:#0b1442; margin:8px 0; padding:6px}
summary{cursor:pointer; list-style:none; display:flex; align-items:center; gap:8px; font-weight:800; font-size:13px}
summary::-webkit-details-marker{display:none}
summary .chev{transition:.2s}
details[open] summary .chev{transform:rotate(90deg)}
.field{display:flex;flex-direction:column;gap:4px;min-width:140px}
.field label{font-size:11px;color:#a9c2ff}
.field input,.field select{background:#08133a;border:1px solid #203780;color:#eaf2ff;border-radius:10px;padding:.5rem .6rem;font-size:14px}
.btn{--c1:#10306a; --c2:#0c2250; background:linear-gradient(135deg,var(--c1),var(--c2));border:1px solid #2847a0;color:#eaf2ff;padding:.55rem .8rem;border-radius:10px;font-weight:800;cursor:pointer;font-size:14px}
.toggle{display:inline-flex;align-items:center;gap:6px;font-size:13px}
.range{appearance:none;width:100%;height:12px;border-radius:999px;background:#0b1848;border:1px solid #21406e}
.range::-webkit-slider-thumb{appearance:none;width:22px;height:22px;border-radius:50%;background:#9ef;border:1px solid #2b6;box-shadow:0 0 10px #8ff}
.range::-moz-range-thumb{width:22px;height:22px;border-radius:50%;background:#9ef;border:1px solid #2b6;box-shadow:0 0 10px #8ff}

/* JUMBO (compact) SCRUBBER */
.range.jumbo{height:28px;border-width:2px;background:
  linear-gradient(#0f2050,#0f2050) padding-box,
  repeating-linear-gradient(90deg, #233d72 0 2px, transparent 2px 14px) border-box;
position:relative}
.range.jumbo::-webkit-slider-thumb{width:36px;height:36px;margin-top:-4px;border-radius:10px}
.range.jumbo::-moz-range-thumb{width:36px;height:36px;border-radius:10px}
.scrubWrap{position:relative;width:100%}
#scrubLabel{position:absolute;top:-28px;transform:translateX(-50%);background:#091638;border:1px solid #1f3a78;padding:.2rem .4rem;border-radius:8px;font-size:11px;color:#d6e6ff;white-space:nowrap;pointer-events:none}
#scrubTicks{display:flex;justify-content:space-between;margin-top:4px;font-size:10px;color:#9fb7ff;opacity:.9}
#scrubTicks span{min-width:40px;text-align:center}

/* Mini calendar ‚Äî single row, no wrap */
#miniCal{display:flex;gap:6px;align-items:center;flex-wrap:nowrap;width:100%;overflow-x:auto}
.calbtn{cursor:pointer;border:1px solid #21406e;background:#0b1442;color:#dbe7ff;border-radius:10px;padding:.35rem .5rem;display:flex;flex-direction:column;align-items:center;min-width:54px}
.calbtn .dow{font-size:9px;color:#a9c2ff}
.calbtn .day{font-size:15px;font-weight:900}
.calbtn .mon{font-size:9px;color:#9ec3ff}
.calbtn.active{background:#10205a;border-color:#3f69d6;box-shadow:0 0 0 2px rgba(126,231,255,.18) inset}
.calbtn.today{border-color:#5ea9ff}
#calInfo{margin-left:auto;color:#b9d3ff;font-size:11px;opacity:.9}

.legend{position:absolute;left:10px;bottom:10px;font-size:11px;color:#a9c2ff;background:#07101cbb;border:1px solid #122341;border-radius:8px;padding:6px 8px}
#redveil{position:fixed;inset:0;pointer-events:none;background:rgba(255,40,40,0.18);opacity:0;transition:.2s;z-index:1000}
html.night #redveil{opacity:1}
#toast{position:fixed;left:16px;bottom:16px;background:#0e1a2f;border:1px solid #21406e;padding:.5rem .7rem;border-radius:12px;color:#eaf2ff;opacity:0;transform:translateY(8px);transition:.25s}

/* iPad landscape tuning */
@media (max-height: 1050px){
  #app{grid-template-rows:60px 1fr 168px;grid-template-columns:400px 1fr}
}

/* iPad portrait tuning */
@media (max-width: 1040px){
  #app{grid-template-columns:360px 1fr}
}
</style>

<!-- SGP4 for satellites -->
<script src="https://cdn.jsdelivr.net/npm/satellite.js@5.0.1/dist/satellite.min.js"></script>
</head>
<body>
<div id="redveil"></div>
<div id="app">
  <header>
    <div id="brand"><div id="logo"></div><h1>ü™ê Pocket Planetarium</h1></div>
    <span class="badge">v1.14.13</span>
    <span class="pill">W√óH <span id="wh">‚Äî</span></span>
    <span class="pill">LST <span id="lstRead">‚Äî</span></span>
    <span id="launchBadge" class="badge" style="display:none">üöÄ Launch in <span id="badgeCountdown">‚Äî</span></span>
    <span style="flex:1"></span>
    <button class="btn" id="nightToggle">üåò Night Vision</button>
  </header>

  <aside id="left" class="panel">
    <details open>
      <summary><span class="chev">‚ñ∂</span> üó∫Ô∏è Where &amp; When</summary>
      <div class="row">
        <div class="field"><label>Latitude (¬∞)</label><input id="lat" type="number" step="0.0001" value="33.422"/></div>
        <div class="field"><label>Longitude (¬∞)</label><input id="lon" type="number" step="0.0001" value="-111.822"/></div>
      </div>
      <div class="row">
        <div class="field"><label>Date</label><input id="date" type="date"/></div>
        <div class="field"><label>Time (local)</label><input id="time" type="time" step="1"/></div>
      </div>
      <div class="row">
        <button class="btn" id="btnNow">‚òÑÔ∏è Now</button>
        <button class="btn" id="btnGeo">üõ∞Ô∏è Use My Location</button>
      </div>
    </details>

    <details open>
      <summary><span class="chev">‚ñ∂</span> üñºÔ∏è View</summary>
      <div class="row" style="width:100%">
        <div class="field" style="flex:1"><label>Zoom</label><input type="range" id="zoom" class="range" min="0.6" max="3.0" step="0.01" value="1.0"/></div>
        <div class="field" style="flex:1"><label>Field of View (¬∞)</label><input type="range" id="fov" class="range" min="80" max="200" step="1" value="180"/></div>
      </div>
      <div class="row" style="width:100%">
        <div class="field" style="flex:1"><label>Star limit (mag) ‚Äî ‚â§ <span id="magRead">6.5</span></label><input type="range" id="magLimit" class="range" min="0" max="8" step="0.1" value="6.5"/></div>
      </div>
      <div class="row">
        <label class="toggle"><input id="toggleStars" type="checkbox" checked/><span>Stars</span></label>
        <label class="toggle"><input id="togglePlanets" type="checkbox" checked/><span>Planets</span></label>
        <label class="toggle"><input id="toggleDSO" type="checkbox" checked/><span>Deep Sky</span></label>
        <label class="toggle"><input id="toggleRadiants" type="checkbox" checked/><span>Meteor Radiants</span></label>
        <label class="toggle"><input id="toggleSat" type="checkbox" checked/><span>Satellites/ISS</span></label>
        <label class="toggle"><input id="labels" type="checkbox" checked/><span>Labels</span></label>
        <label class="toggle"><input id="grid" type="checkbox" checked/><span>Az/Alt grid</span></label>
        <label class="toggle"><input id="ecliptic" type="checkbox" checked/><span>Ecliptic</span></label>
        <label class="toggle"><input id="constLines" type="checkbox" checked/><span>Constellations</span></label>
      </div>
    </details>

    <details>
      <summary><span class="chev">‚ñ∂</span> ‚åæ Deep-Sky Objects</summary>
      <div class="row">
        <div class="field" style="flex:2"><label>Search</label><input id="dsoSearch" placeholder="e.g., Andromeda, Orion‚Ä¶"/></div>
        <div class="field" style="flex:1"><label>Type</label>
          <select id="dsoType">
            <option value="">All types</option>
            <option>Galaxy</option>
            <option>Nebula</option>
            <option>Open Cluster</option>
            <option>Globular Cluster</option>
            <option>PN</option>
          </select>
        </div>
        <div class="field" style="flex:1"><label>Max DSO magnitude ‚Äî ‚â§ <span id="dsoMagRead">12.0</span></label><input id="dsoMagLimit" type="range" class="range" min="6" max="14" step="0.1" value="12"/></div>
      </div>
      <div id="dsoList" class="list"></div>
    </details>

    <details id="meteorDetails">
      <summary><span class="chev">‚ñ∂</span> ‚òÑÔ∏è Meteor Showers</summary>
      <div id="meteorList" class="list"></div>
    </details>

    <details>
      <summary><span class="chev">‚ñ∂</span> üõ∞Ô∏è Satellites & ISS</summary>
      <div class="row" style="font-size:12px;color:#a9c2ff">Uses live TLE (internet) to draw the ISS and list next visible passes (~12h).</div>
      <div id="satStatus" class="pill">Fetching ISS TLE‚Ä¶</div>
      <div id="issNext" class="list"></div>
    </details>

    <details>
      <summary><span class="chev">‚ñ∂</span> üöÄ Launch Alerts (auto)</summary>
      <div class="row">
        <label class="toggle"><input id="launchTrack" type="checkbox" checked/><span>Draw trajectory</span></label>
        <button id="clearTraj" class="btn">üßπ Clear</button>
      </div>
      <div id="launchList"></div>
      <div class="row"><span class="pill" id="launchStatus">Fetching upcoming SpaceX launches near KSC/VBG‚Ä¶</span></div>
      <div class="row" style="font-size:12px;color:#a9c2ff">Trajectory draws only if your location is within ~1200 km of the pad.</div>
    </details>
  </aside>

  <div id="canvasWrap">
    <canvas id="sky"></canvas>
    <canvas id="overlay"></canvas>
    <div class="legend"><div><strong>Legend:</strong> ‚óè star, ‚åæ DSO, ‚ôÇ/‚ôÄ/‚ôÉ planet, ‚ú¥ radiant, ‚Äî constellation, ‚§¥Ô∏é launch, ‚óâ ISS</div><div>Horizon = circle edge ‚Ä¢ North ‚Üë</div></div>
  </div>

  <div id="bottom">
    <div class="row" style="width:100%">
      <span class="pill">Œî <span id="deltaRead">+0m</span></span>
      <span class="pill">üïí <span id="clockRead">‚Äî:‚Äî:‚Äî</span></span>
      <button class="btn" id="jumpMinusDay">‚àí1d</button>
      <button class="btn" id="jumpMinus12h">‚àí12h</button>
      <button class="btn" id="jumpNow">Now</button>
      <button class="btn" id="jumpPlus12h">+12h</button>
      <button class="btn" id="jumpPlusDay">+1d</button>
      <button class="btn" id="resetView" style="margin-left:auto">üîÑ Reset View</button>
    </div>
    <div class="row" style="width:100%">
      <div class="scrubWrap">
        <div id="scrubLabel">‚Äî</div>
        <input id="timeScrub" class="range jumbo" type="range" min="-432000" max="432000" step="60" value="0" />
        <div id="scrubTicks">
          <span>‚àí5d</span><span>‚àí3d</span><span>‚àí1d</span><span>‚àí12h</span><span>Now</span><span>+12h</span><span>+1d</span><span>+3d</span><span>+5d</span>
        </div>
      </div>
    </div>
    <div id="miniCal" class="row"><span id="calInfo">‚Äî</span></div>
  </div>
</div>

<div id="toast">‚Äî</div>

<script>
// Error surfacing
window.addEventListener('error', e=> toast('JS error: '+(e.message||e)));
function toast(msg, t=2000){ const el=document.getElementById('toast'); el.textContent=msg; el.style.opacity=1; el.style.transform='translateY(0)'; setTimeout(()=>{ el.style.opacity=0; el.style.transform='translateY(8px)'; }, t); }

// Core math
const DEG=Math.PI/180, RAD=180/Math.PI, clamp=(x,a,b)=>Math.max(a,Math.min(b,x)), mod=(x,m)=>((x%m)+m)%m, pad=n=>n.toString().padStart(2,'0');
function jdFromDate(date){ return Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate(), date.getUTCHours(), date.getUTCMinutes(), date.getUTCSeconds())/86400000 + 2440587.5; }
function gmst(jd){ const T=(jd-2451545.0)/36525.0; let s=67310.54841 + (876600*3600 + 8640184.812866)*T + 0.093104*T*T - 6.2e-6*T*T*T; return mod(s,86400)/240.0*DEG; }
function lst(jd, lonRad){ return mod(gmst(jd) + lonRad, 2*Math.PI); }
function radecFromEcliptic(lam, beta){ const eps=23.43928*DEG; const sinDec=Math.sin(beta)*Math.cos(eps)+Math.cos(beta)*Math.sin(eps)*Math.sin(lam); const dec=Math.asin(clamp(sinDec,-1,1)); const y=Math.sin(lam)*Math.cos(eps)-Math.tan(beta)*Math.sin(eps); const x=Math.cos(lam); return {ra:mod(Math.atan2(y,x),2*Math.PI), dec}; }
function azAltFromRADec(ra, dec, lat, lstRad){ const H=mod(lstRad - ra,2*Math.PI); const sinAlt=Math.sin(dec)*Math.sin(lat)+Math.cos(dec)*Math.cos(lat)*Math.cos(H); const alt=Math.asin(clamp(sinAlt,-1,1)); const cosAz=(Math.sin(dec)-Math.sin(alt)*Math.sin(lat))/(Math.cos(alt)*Math.cos(lat)); let az=Math.acos(clamp(cosAz,-1,1)); if(Math.sin(H)>0) az=2*Math.PI-az; return {az,alt}; }
function seededRandom(seed){ let t=seed>>>0; return function(){ t=(t+0x6D2B79F5)|0; let r=Math.imul(t^(t>>>15),1|t); r^=r+Math.imul(r^(t>>>7),61|t); return ((r^(r>>>14))>>>0)/4294967296; };}
function makeStars(n=6500, seed=2025){ const rnd=seededRandom(seed), out=[]; for(let i=0;i<n;i++){ const u=rnd(), v=rnd(), w=rnd(); const ra=2*Math.PI*u; const x=Math.acos(1-2*v)-Math.PI/2; const bias=0.35*Math.sin(ra*0.5)+0.45*Math.sin((ra+1.2)*1.0); const dec=clamp(x+bias*DEG*15,-Math.PI/2,Math.PI/2); const mag=1.3 + -2*Math.log10(0.02+w*w); out.push({ra,dec,mag}); } return out; }
const stars=makeStars();

// DSO sample
function raRad(h,m){ return ((h*15)+(m*0.25))*DEG; }
const DSO=[
 {name:"M31 Andromeda",ra:raRad(0,42),dec:41.3*DEG,type:"Galaxy",mag:3.4,dist:"2.5 Mly",size:"190‚Ä≤√ó60‚Ä≤"},
 {name:"M42 Orion",ra:raRad(5,35),dec:-5.5*DEG,type:"Nebula",mag:4.0,dist:"1.3 kly",size:"65‚Ä≤√ó60‚Ä≤"},
 {name:"M45 Pleiades",ra:raRad(3,47),dec:24*DEG,type:"Open Cluster",mag:1.6,size:"110‚Ä≤"},
 {name:"M13 Hercules",ra:raRad(16,41),dec:36.5*DEG,type:"Globular Cluster",mag:5.8,size:"20‚Ä≤"},
 {name:"NGC 7000 North America", ra: raRad(20,58), dec: 44*DEG, type:"Nebula", mag:4, size:"120‚Ä≤√ó100‚Ä≤"},
 {name:"M57 Ring",ra:raRad(18,53),dec:33*DEG,type:"PN",mag:8.8,size:"1.5‚Ä≤"}
];

// Meteor radiants
const RADIANTS=[
 {name:"Quadrantids", peak:"01-03", ra:230*DEG, dec:49*DEG, width:3},
 {name:"Lyrids",      peak:"04-22", ra:271*DEG, dec:34*DEG, width:3},
 {name:"Perseids",    peak:"08-12", ra:46*DEG,  dec:58*DEG, width:6},
 {name:"Geminids",    peak:"12-14", ra:112*DEG, dec:33*DEG, width:5}
];

// Expanded constellation lines (a small curated set)
const CONSTLINES=[
 {name:"Orion", lines:[
  [[raRad(5,55),7.4*DEG],[raRad(5,25),6.3*DEG]],
  [[raRad(5,25),6.3*DEG],[raRad(5,32),0.3*DEG],[raRad(5,36),-1.2*DEG],[raRad(5,40),-1.9*DEG]],
  [[raRad(5,32),0.3*DEG],[raRad(5,55),7.4*DEG]],
  [[raRad(5,40),-1.9*DEG],[raRad(5,47),-9.7*DEG],[raRad(5,14),-8.2*DEG]]
 ]},
 {name:"Ursa Major", lines:[
  [[raRad(11,4),61.8*DEG],[raRad(11,1),56.4*DEG],[raRad(11,54),53.7*DEG],[raRad(12,15),57.0*DEG],[raRad(12,54),55.9*DEG],[raRad(13,24),54.9*DEG],[raRad(13,48),49.3*DEG]]
 ]},
 {name:"Cassiopeia", lines:[
  [[raRad(0,56),60.7*DEG],[raRad(1,26),60.2*DEG],[raRad(2,29),59.1*DEG],[raRad(2,45),67.4*DEG],[raRad(0,10),59.2*DEG]]
 ]},
 {name:"Cygnus", lines:[
  [[raRad(19,36),38.8*DEG],[raRad(20,41),45.3*DEG],[raRad(20,25),42.0*DEG],[raRad(19,31),27.3*DEG],[raRad(19,30),53.4*DEG]]
 ]},
 {name:"Scorpius", lines:[
  [[raRad(16,21),-26.4*DEG],[raRad(16,29),-26.4*DEG],[raRad(16,36),-28.2*DEG],[raRad(16,53),-38.0*DEG],[raRad(17,34),-37.0*DEG],[raRad(17,37),-42.9*DEG],[raRad(17,42),-49.9*DEG]]
 ]},
 {name:"Leo", lines:[
  [[raRad(10,8),11.9*DEG],[raRad(10,20),19.8*DEG],[raRad(10,19),23.4*DEG],[raRad(11,14),20.5*DEG],[raRad(11,49),14.6*DEG],[raRad(11,49),14.6*DEG],[raRad(11,14),15.4*DEG],[raRad(10,7),16.0*DEG]]
 ]}
];

// Launch sites
const KSC={name:"KSC/Cape", lat:28.6084, lon:-80.6043};
const VBG={name:"Vandenberg", lat:34.632, lon:-120.611};

// DOM & state
const sky=document.getElementById('sky'), ol=document.getElementById('overlay'), wrap=document.getElementById('canvasWrap');
const ctx=sky.getContext('2d'), octx=ol.getContext('2d');
const whEl=document.getElementById('wh'), lstEl=document.getElementById('lstRead'), clockRead=document.getElementById('clockRead'), deltaRead=document.getElementById('deltaRead');
const launchBadge=document.getElementById('launchBadge'), badgeCountdown=document.getElementById('badgeCountdown'), launchStatus=document.getElementById('launchStatus'), launchList=document.getElementById('launchList');
const satStatus=document.getElementById('satStatus'), issNextEl=document.getElementById('issNext');
const meteorDetails=document.getElementById('meteorDetails'), meteorList=document.getElementById('meteorList');
let W=0,H=0,R=0, scale=1, fov=180*DEG; let lat=33.422*DEG, lon=-111.822*DEG;
let baseTime=new Date(), offsetSeconds=0, yaw=0, pitch=0, mirror=false;
let showLabels=true, showGrid=true, showEcliptic=true, showConst=true;
let showStars=true, showDSO=true, showRadiants=true, showSat=true, showPlanets=true;
let magLimit=6.5;
let currentLST=0; let drawLaunchTrack=true; let launches=[], activeId=null;
let issTLE=null, issSatrec=null;

// Sizing
function safeSize(){ let w=wrap.clientWidth, h=wrap.clientHeight; if(!w||!h){ w=Math.max(640, Math.floor(window.innerWidth*0.9)); h=Math.max(400, Math.floor(window.innerHeight*0.58)); wrap.style.minHeight=h+'px'; } return {w,h}; }
function resize(){ const dpr=Math.max(1,Math.min(2.5,window.devicePixelRatio||1)); const s=safeSize(); W=s.w; H=s.h; if(!W||!H){ W=960; H=560; } R=Math.min(W,H)/2;
  sky.width=Math.floor(W*dpr); sky.height=Math.floor(H*dpr); ol.width=sky.width; ol.height=sky.height;
  sky.style.width=W+'px'; sky.style.height=H+'px'; ol.style.width=W+'px'; ol.style.height=H+'px';
  ctx.setTransform(dpr,0,0,dpr,0,0); octx.setTransform(dpr,0,0,dpr,0,0); whEl.textContent=W+'√ó'+H; draw(true); }

// Time
function currentTime(){ return new Date(baseTime.getTime() + offsetSeconds*1000); }
function updateDeltaRead(){ const s=Math.abs(offsetSeconds); const sign=offsetSeconds>=0?"+":"‚àí"; const d=Math.floor(s/86400); const h=Math.floor((s%86400)/3600); const m=Math.floor((s%3600)/60); let txt=`${sign}`; if(d) txt+=`${d}d `; if(h) txt+=`${h}h `; txt+=`${m}m`; deltaRead.textContent=txt; }
function setInputsFromBase(){ const local=new Date(baseTime.getTime()); document.getElementById('date').value=`${local.getFullYear()}-${String(local.getMonth()+1).padStart(2,'0')}-${String(local.getDate()).padStart(2,'0')}`; document.getElementById('time').value=`${String(local.getHours()).padStart(2,'0')}:${String(local.getMinutes()).padStart(2,'0')}:${String(local.getSeconds()).padStart(2,'0')}`; }

// Projection + draw
function project(az, alt){ const theta=(Math.PI/2 - alt), maxTheta=fov/2; if(theta>maxTheta) return null; const r=(theta/maxTheta)*R*scale;
  let x=r*Math.sin(az + yaw), y=-r*Math.cos(az + yaw); const c=Math.cos(pitch); const yy=y*c; if(mirror) x=-x; return {x:W/2+x, y:H/2+yy, r}; }
function drawBackground(){ ctx.clearRect(0,0,W,H); const g=ctx.createRadialGradient(W/2,H/2,0,W/2,H/2,R*1.12); g.addColorStop(0,"rgba(6,16,30,0)"); g.addColorStop(1,"rgba(0,0,0,0.7)"); ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
  ctx.strokeStyle="#203456"; ctx.lineWidth=1.3; ctx.beginPath(); ctx.arc(W/2,H/2,R*scale,0,2*Math.PI); ctx.stroke(); const n=project(0,0); if(n){ ctx.fillStyle="#9bb2da"; ctx.font="11px system-ui"; ctx.fillText("N", n.x-3, n.y-6); } }
function drawGrid(){ if(!showGrid) return; ctx.strokeStyle="#1f3358"; ctx.lineWidth=0.8; ctx.setLineDash([4,6]); ctx.beginPath(); for(let alt=75*DEG; alt>0; alt-=15*DEG){ const theta=(Math.PI/2 - alt); const r=(theta/(fov/2))*R*scale; ctx.moveTo(W/2+r, H/2); ctx.arc(W/2,H/2,r,0,2*Math.PI); } ctx.stroke(); ctx.setLineDash([]);
  ctx.strokeStyle="#25406b"; for(let az=0; az<360; az+=30){ const a=az*DEG; const p1=project(a,0.001), p2=project(a,Math.PI/2-0.001); if(p1&&p2){ ctx.beginPath(); ctx.moveTo(p1.x,p1.y); ctx.lineTo(p2.x,p2.y); ctx.stroke(); if(showLabels){ ctx.fillStyle="#7ea1d6"; ctx.font="10px system-ui"; ctx.fillText(`${az}¬∞`, p1.x+4, p1.y+4);} } } }
function drawEcliptic(){ if(!showEcliptic) return; ctx.strokeStyle="#ffcf70"; ctx.lineWidth=1.1; ctx.setLineDash([6,4]); ctx.beginPath(); for(let L=0;L<=360;L+=2){ const {ra,dec}=radecFromEcliptic(L*DEG,0); const {az,alt}=azAltFromRADec(ra,dec,lat,currentLST); const p=project(az,alt); if(!p) continue; if(L===0) ctx.moveTo(p.x,p.y); else ctx.lineTo(p.x,p.y); } ctx.stroke(); ctx.setLineDash([]); }
function drawStars(){ if(!showStars) return; const t=currentTime(); const jd=jdFromDate(t); currentLST=lst(jd, lon); for(const s of stars){ if(s.mag>magLimit) continue; const {az,alt}=azAltFromRADec(s.ra,s.dec,lat,currentLST); if(alt<=0) continue; const p=project(az,alt); if(!p) continue; const size=clamp(2.4 - 0.30*s.mag,0.6,2.4); const alpha=clamp(1.05 - 0.12*s.mag,0.25,0.9); ctx.fillStyle=`rgba(210,230,255,${alpha.toFixed(2)})`; ctx.beginPath(); ctx.arc(p.x,p.y,size,0,2*Math.PI); ctx.fill(); } }
function drawDSOOnSky(){ if(!showDSO) return; ctx.save(); ctx.fillStyle="#a8ffe0"; ctx.strokeStyle="#a8ffe0"; ctx.lineWidth=1; ctx.font="10px system-ui"; for(const d of DSO){ const {az,alt}=azAltFromRADec(d.ra,d.dec,lat,currentLST); if(alt<=0) continue; const p=project(az,alt); if(!p) continue; ctx.beginPath(); ctx.arc(p.x,p.y,3,0,2*Math.PI); ctx.stroke(); if(showLabels) ctx.fillText(`‚åæ ${d.name}`, p.x+6, p.y-6);} ctx.restore(); }
function drawConstellations(){ if(!showConst) return; ctx.save(); ctx.strokeStyle="rgba(130,170,255,0.6)"; ctx.lineWidth=0.9; ctx.setLineDash([6,4]); for(const C of CONSTLINES){ for(const poly of C.lines){ let first=true; ctx.beginPath(); for(const [ra,dec] of poly){ const {az,alt}=azAltFromRADec(ra,dec,lat,currentLST); if(alt<=0) { first=true; continue; } const p=project(az,alt); if(!p){ first=true; continue; } if(first){ ctx.moveTo(p.x,p.y); first=false; } else ctx.lineTo(p.x,p.y); } ctx.stroke(); } } ctx.setLineDash([]); ctx.restore(); }
function drawRadiants(){ if(!showRadiants) return; const t=currentTime(); const doy = (d)=>{ const start=new Date(d.getFullYear(),0,1); return Math.floor((d-start)/(24*3600*1000))+1; }; const md2doy=(md,yr)=>{ const [m,dd]=md.split('-').map(Number); return doy(new Date(yr,m-1,dd)); };
  const yr=t.getFullYear(); const today=doy(t);
  for(const R of RADIANTS){ const pday=md2doy(R.peak, yr); const delta=Math.min(Math.abs(pday-today), 365-Math.abs(pday-today)); if(delta>10) continue;
    const {az,alt}=azAltFromRADec(R.ra,R.dec,lat,currentLST); if(alt<=0) continue; const p=project(az,alt); if(!p) continue;
    const pulse = (1+Math.sin(Date.now()/600))/2;
    octx.save(); octx.strokeStyle=`rgba(255,170,120,${0.7+0.3*pulse})`; octx.lineWidth=1.2;
    octx.beginPath(); octx.arc(p.x,p.y, 10 + 6*pulse, 0, 2*Math.PI); octx.stroke();
    octx.beginPath(); octx.moveTo(p.x-6,p.y); octx.lineTo(p.x+6,p.y); octx.moveTo(p.x,p.y-6); octx.lineTo(p.x,p.y+6); octx.stroke();
    if(showLabels){ octx.fillStyle="#ffd9b3"; octx.font="10px system-ui"; octx.fillText(`‚ú¥ ${R.name}`, p.x+10, p.y-8); }
    octx.restore();
  }
}

// Planets (Mercury‚ÜíSaturn) ‚Äî low-precision J2000 elements
const PLANETS=[
 {key:"Mercury", sym:"‚òø", color:"#ffd780", size:3.5, el:{ a:[0.38709927, 0.00000037], e:[0.20563593, 0.00001906], I:[7.00497902,-0.00594749], L:[252.25032350,149472.67411175], wbar:[77.45779628,0.16047689], O:[48.33076593,-0.12534081] } },
 {key:"Venus",   sym:"‚ôÄ", color:"#ffd4c2", size:4.0, el:{ a:[0.72333566, 0.00000390], e:[0.00677672,-0.00004107], I:[3.39467605,-0.00078890], L:[181.97909950,58517.81538729], wbar:[131.60246718,0.00268329], O:[76.67984255,-0.27769418] } },
 {key:"Earth",   sym:"‚äï", color:"#a0e1ff", size:4.0, el:{ a:[1.00000261, 0.00000562], e:[0.01671123,-0.00004392], I:[-0.00001531,-0.01294668], L:[100.46457166,35999.37244981], wbar:[102.93768193,0.32327364], O:[0.0,0.0] } },
 {key:"Mars",    sym:"‚ôÇ", color:"#ff9b6b", size:3.8, el:{ a:[1.52371034, 0.00001847], e:[0.09339410,0.00007882], I:[1.84969142,-0.00813131], L:[-4.55343205,19140.30268499], wbar:[-23.94362959,0.44441088], O:[49.55953891,-0.29257343] } },
 {key:"Jupiter", sym:"‚ôÉ", color:"#ffdca8", size:5.0, el:{ a:[5.20288700,-0.00011607], e:[0.04838624,-0.00013253], I:[1.30439695,-0.00183714], L:[34.39644051,3034.74612775], wbar:[14.72847983,0.21252668], O:[100.47390909,0.20469106] } },
 {key:"Saturn",  sym:"‚ôÑ", color:"#ffe9a6", size:4.8, el:{ a:[9.53667594,-0.00125060], e:[0.05386179,-0.00050991], I:[2.48599187,0.00193609], L:[49.95424423,1222.49362201], wbar:[92.59887831,-0.41897216], O:[113.66242448,-0.28867794] } },
];
function centuriesSinceJ2000(jd){ return (jd-2451545.0)/36525.0; }
function keplerE(M,e){ let E=M, d; for(let i=0;i<8;i++){ d=(E - e*Math.sin(E) - M); E=E - d/(1 - e*Math.cos(E)); if(Math.abs(d)<1e-12) break; } return E; }
function planetHelioEclRect(el,T){
  const a=el.a[0]+el.a[1]*T, e=el.e[0]+el.e[1]*T, I=(el.I[0]+el.I[1]*T)*DEG, L=(el.L[0]+el.L[1]*T)*DEG, wbar=(el.wbar[0]+el.wbar[1]*T)*DEG, O=(el.O[0]+el.O[1]*T)*DEG;
  const M = mod(L - wbar, 2*Math.PI);
  const E = keplerE(M,e);
  const xw = a*(Math.cos(E) - e);
  const yw = a*(Math.sqrt(1-e*e) * Math.sin(E));
  const œâ = mod(wbar - O, 2*Math.PI);
  // rotation to ecliptic
  const cosO=Math.cos(O), sinO=Math.sin(O), cosi=Math.cos(I), sini=Math.sin(I), cosw=Math.cos(œâ), sinw=Math.sin(œâ);
  const x = (cosO*cosw - sinO*sinw*cosi)*xw + (-cosO*sinw - sinO*cosw*cosi)*yw;
  const y = (sinO*cosw + cosO*sinw*cosi)*xw + (-sinO*sinw + cosO*cosw*cosi)*yw;
  const z = (sinw*sini)*xw + (cosw*sini)*yw;
  return {x,y,z};
}
function planetGeoEcl(planet, jd){
  const T=centuriesSinceJ2000(jd);
  const p = planetHelioEclRect(planet.el, T);
  const e = planetHelioEclRect(PLANETS[2].el, T); // Earth
  const x=p.x - e.x, y=p.y - e.y, z=p.z - e.z;
  const lam = mod(Math.atan2(y,x), 2*Math.PI); const beta = Math.atan2(z, Math.sqrt(x*x+y*y));
  return {lam, beta};
}
function drawPlanets(){
  if(!showPlanets) return;
  const t=currentTime(); const jd=jdFromDate(t);
  ctx.save();
  for(const P of PLANETS){
    if(P.key==="Earth") continue;
    const {lam,beta}=planetGeoEcl(P, jd);
    const {ra,dec}=radecFromEcliptic(lam,beta);
    const {az,alt}=azAltFromRADec(ra,dec,lat,currentLST);
    if(alt<=0) continue;
    const p=project(az,alt); if(!p) continue;
    ctx.fillStyle=P.color; ctx.strokeStyle=P.color;
    ctx.beginPath(); ctx.arc(p.x,p.y,P.size,0,2*Math.PI); ctx.fill();
    if(showLabels){ ctx.font="11px system-ui"; ctx.fillText(`${P.sym} ${P.key}`, p.x+8, p.y-6); }
  }
  ctx.restore();
}

// Launches (unchanged core)
function distanceKm(œÜ1,Œª1,œÜ2,Œª2){ const dœÜ=œÜ2-œÜ1, dŒª=Œª2-Œª1; const a=Math.sin(dœÜ/2)**2 + Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(dŒª/2)**2; return 2*6371*Math.asin(Math.min(1,Math.sqrt(a))); }
function bearingTo(lat2, lon2){ const œÜ1=lat, Œª1=lon, œÜ2=lat2, Œª2=lon2; const y=Math.sin(Œª2-Œª1)*Math.cos(œÜ2); const x=Math.cos(œÜ1)*Math.sin(œÜ2)-Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(Œª2-Œª1); return mod(Math.atan2(y,x),2*Math.PI); }
function classifyAzimuth(site, orbit){ const o=(orbit||"").toUpperCase(); if(site.name.includes("Vandenberg")){ if(o.includes("SSO")||o.includes("POL")) return 190*DEG; return 200*DEG; } else { if(o.includes("GTO")) return 95*DEG; if(o.includes("ISS")||o.includes("LEO")) return 55*DEG; return 80*DEG; } }
function softstep(x){ return 1/(1+Math.exp(-x)); }
function visibleLaunchFromHere(L){ const d = distanceKm(lat,lon, L.site.lat*DEG, L.site.lon*DEG); return d <= 1200; }
function trajPointsForLaunch(L){
  const brObs = bearingTo(L.site.lat*DEG, L.site.lon*DEG); const azNom = classifyAzimuth(L.site, L.orbit);
  const dist = distanceKm(lat,lon, L.site.lat*DEG, L.site.lon*DEG);
  const altMax = dist<600? 70*DEG : dist<1100? 45*DEG : dist<1800? 25*DEG : 12*DEG;
  const spanMin = 18; const pts=[];
  for(let m=-2; m<=spanMin; m+=0.5){ const t = m; const up = softstep((t-2.5)*0.9); const down = 1 - 0.25*softstep((t-9)*0.7); const alt = clamp((altMax * up * down), 3*DEG, Math.PI/2); const drift = clamp((t+2)/10, 0, 1); const az = mod(brObs*(1-drift) + azNom*drift, 2*Math.PI); const p=project(az, alt); if(p) pts.push({x:p.x,y:p.y, tMin:m}); }
  return pts;
}
function drawLaunchTrajectory(){
  if(!drawLaunchTrack || !launches.length || !activeId) { octx.clearRect(0,0,ol.width,ol.height); return; }
  const L = launches.find(x=> x.id===activeId); if(!L) return;
  if(!visibleLaunchFromHere(L)) return;
  const pts = trajPointsForLaunch(L); if(!pts.length) return;
  octx.save(); octx.clearRect(0,0,ol.width,ol.height); octx.strokeStyle="rgba(255,211,110,0.95)"; octx.lineWidth=1.6; octx.setLineDash([10,5]);
  octx.beginPath(); octx.moveTo(pts[0].x, pts[0].y); for(let i=1;i<pts.length;i++){ octx.lineTo(pts[i].x, pts[i].y); } octx.stroke(); octx.setLineDash([]);
  octx.restore();
}
async function fetchLaunches(){
  try{
    launchStatus.textContent="Fetching from Launch Library 2‚Ä¶";
    const url="https://ll.thespacedevs.com/2.2.0/launch/upcoming/?mode=detailed&limit=50&search=SpaceX";
    const resp=await fetch(url, {headers:{'Accept':'application/json'}});
    const data=await resp.json();
    const out=[];
    for(const L of (data.results||[])){
      const siteName = (L.pad?.location?.name||"") + " " + (L.pad?.name||"");
      const isKSC = /Kennedy|Canaveral|Cape/i.test(siteName);
      const isVBG = /Vandenberg/i.test(siteName);
      if(!isKSC && !isVBG) continue;
      const net = L.net ? new Date(L.net) : null;
      const wend = L.window_end ? new Date(L.window_end) : (net? new Date(net.getTime()+60*60000): null);
      out.push({ site: isKSC? KSC : VBG, id:L.id, name:L.name, provider:L.launch_service_provider?.name||"", vehicle:L.rocket?.configuration?.full_name||L.rocket?.configuration?.name||"", net, window_end: wend, orbit: L.mission?.orbit?.abbrev || L.mission?.orbit?.name || (L.mission?.name||""), pad: siteName });
    }
    const bySite={}; for(const x of out){ const key=x.site.name; if(!bySite[key] || (x.net && bySite[key].net && x.net<bySite[key].net)) bySite[key]=x; }
    launches = Object.values(bySite).sort((a,b)=> (a.net||0) - (b.net||0));
    renderLaunchList();
    launchStatus.textContent = launches.length? "Auto alerts armed (2h prewindow)" : "No upcoming SpaceX launches at KSC/VBG found.";
  }catch(e){ launchStatus.textContent="Launch fetch failed (offline?)"; console.error(e); }
}
function fmtUTC(d){ if(!d) return "TBD"; return d.toISOString().replace('T',' ').slice(0,16)+"Z"; }
function renderLaunchList(){
  if(!launches.length){ launchList.innerHTML=""; return; }
  const html = launches.map(L=>`<div class="item">
      <div>
        <div><strong>${L.name}</strong></div>
        <div class="meta">${L.provider} ‚Ä¢ ${L.vehicle} ‚Ä¢ ${L.pad}</div>
        <div class="meta">NET ${fmtUTC(L.net)}${L.window_end? ` ‚Ä¢ window ends ${L.window_end.toISOString().slice(11,16)}Z` : ""} ‚Ä¢ ${L.orbit||""}</div>
      </div>
      <div class="row">
        <button class="btn" data-jump="${L.id}">View & jump to NET</button>
      </div>
    </div>`).join("");
  launchList.innerHTML = html;
  launchList.querySelectorAll('button[data-jump]').forEach(b=> b.onclick = ()=>{
    const L=launches.find(x=>x.id===b.dataset.jump); if(!L||!L.net) return;
    activeId = L.id; baseTime = new Date(L.net.getTime()); offsetSeconds = 0; setInputsFromBase();
    const br = bearingTo(L.site.lat*DEG, L.site.lon*DEG); yaw = -br; pitch = 0;
    document.getElementById('timeScrub').value = 0; updateDeltaRead(); renderMiniCalendar();
    toast("Jumped to launch NET ‚Äî trajectory overlay active");
    draw();
  });
}

// ISS & satellites
async function loadISS(){
  try{
    satStatus.textContent="Fetching ISS TLE‚Ä¶";
    const resp = await fetch("https://celestrak.org/NORAD/elements/gp.php?GROUP=stations&FORMAT=tle");
    const txt = await resp.text();
    const lines = txt.trim().split(/\r?\n/);
    const idx = lines.findIndex(l=> l.toUpperCase().includes("ISS"));
    const tle1 = lines[idx+1], tle2 = lines[idx+2];
    issTLE = [tle1, tle2];
    issSatrec = satellite.twoline2satrec(tle1, tle2);
    satStatus.textContent="ISS ready";
    computeISSPasses();
  }catch(e){ satStatus.textContent="ISS fetch failed (offline?)"; console.error(e); }
}
function gstFromDate(date){ const jd=jdFromDate(date); return gmst(jd); } // radians
function issRADecAt(date){
  if(!issSatrec) return null;
  const gmst = gstFromDate(date);
  const prop = satellite.propagate(issSatrec, date);
  if(!prop.position) return null;
  const ecf = satellite.eciToEcf(prop.position, gmst);
  const obs = { longitude: lon, latitude: lat, height: 0 };
  const look = satellite.ecfToLookAngles(obs, ecf);
  const az = look.azimuth; const alt = look.elevation;
  return {az, alt};
}
function drawISSMarker(){
  if(!showSat || !issSatrec) return;
  const look = issRADecAt(currentTime()); if(!look) return;
  if(look.alt<=0) return;
  const p=project(look.az, look.alt); if(!p) return;
  octx.save(); octx.fillStyle="#b3ff9c"; octx.strokeStyle="#b3ff9c"; octx.lineWidth=1.2;
  octx.beginPath(); octx.arc(p.x,p.y,4,0,2*Math.PI); octx.fill();
  if(showLabels){ octx.font="10px system-ui"; octx.fillText("‚óâ ISS", p.x+8, p.y-6); }
  octx.restore();
}
function computeISSPasses(){
  if(!issSatrec) return;
  const now = new Date(); const end = new Date(now.getTime()+12*3600000);
  const step = 60*1000; // 1 min
  let visible=false, start=null, peaks=[], res=[];
  for(let t=now.getTime(); t<=end.getTime(); t+=step){
    const d=new Date(t); const look = issRADecAt(d); if(!look) continue;
    const isUp = look.alt>0;
    if(isUp && !visible){ visible=true; start=d; }
    if(isUp){ peaks.push({t:d, alt:look.alt}); }
    if(!isUp && visible){ visible=false; const endt=new Date(t-step); const peak = peaks.reduce((a,b)=> a.alt>b.alt?a:b, peaks[0]); res.push({start, end: endt, maxAlt: (peak.alt*RAD).toFixed(1)+"¬∞"}); peaks=[]; start=null; }
  }
  issNextEl.innerHTML = res.length ? res.slice(0,5).map(p=>`<div class="item"><div><strong>Pass</strong> ${p.start.toLocaleTimeString()}‚Äì${p.end.toLocaleTimeString()} ‚Ä¢ max ${p.maxAlt}</div></div>`).join("") : "<div class='item'><div>No visible passes next ~12h.</div></div>";
}

// Meteor panel rendering/hide
function renderMeteorPanel(){
  const t=currentTime(); const yr=t.getFullYear();
  const doy = (d)=>{ const start=new Date(d.getFullYear(),0,1); return Math.floor((d-start)/(24*3600*1000))+1; }; 
  const md2doy=(md,yr)=>{ const [m,dd]=md.split('-').map(Number); return doy(new Date(yr,m-1,dd)); };
  const today=doy(t);
  const items = RADIANTS.map(r=>{
    const p=md2doy(r.peak, yr); const delta=Math.min(Math.abs(p-today),365-Math.abs(p-today));
    return {...r, delta};
  }).filter(x=> x.delta<=15).sort((a,b)=>a.delta-b.delta);
  if(!items.length){ meteorDetails.style.display='none'; return; }
  meteorDetails.style.display='block';
  meteorList.innerHTML = items.map(r=>`<div class="item"><div><strong>${r.name}</strong> ‚Ä¢ peaks ${r.peak} ‚Ä¢ Œî${r.delta}d</div></div>`).join("");
}

// Controls
document.getElementById('nightToggle').onclick=()=>{ document.documentElement.classList.toggle('night'); };
document.getElementById('zoom').oninput=(e)=>{ scale=parseFloat(e.target.value); draw(); };
document.getElementById('fov').oninput=(e)=>{ fov=parseFloat(e.target.value)*DEG; draw(); };
document.getElementById('magLimit').oninput=(e)=>{ magLimit=parseFloat(e.target.value); document.getElementById('magRead').textContent=magLimit.toFixed(1); draw(); };
document.getElementById('labels').onchange=(e)=>{ showLabels=e.target.checked; draw(); };
document.getElementById('grid').onchange=(e)=>{ showGrid=e.target.checked; draw(); };
document.getElementById('ecliptic').onchange=(e)=>{ showEcliptic=e.target.checked; draw(); };
document.getElementById('constLines').onchange=(e)=>{ showConst=e.target.checked; draw(); };
document.getElementById('toggleStars').onchange=(e)=>{ showStars=e.target.checked; draw(); };
document.getElementById('toggleDSO').onchange=(e)=>{ showDSO=e.target.checked; draw(); };
document.getElementById('toggleRadiants').onchange=(e)=>{ showRadiants=e.target.checked; draw(); };
document.getElementById('toggleSat').onchange=(e)=>{ showSat=e.target.checked; draw(); };
document.getElementById('togglePlanets').onchange=(e)=>{ showPlanets=e.target.checked; draw(); };

["lat","lon","date","time"].forEach(id=>document.getElementById(id).addEventListener('change', ()=>{
  const d=document.getElementById('date').value; const t=document.getElementById('time').value||"00:00:00";
  if(d){ const parts=d.split('-').map(Number); const tp=t.split(':').map(Number); const local=new Date(parts[0],parts[1]-1,parts[2],tp[0]||0,tp[1]||0,tp[2]||0||0); baseTime=new Date(local.getTime()); offsetSeconds=0; document.getElementById('timeScrub').value="0"; updateDeltaRead(); }
  lon=parseFloat(document.getElementById('lon').value||"-111.822")*DEG; lat=parseFloat(document.getElementById('lat').value||"33.422")*DEG; computeISSPasses(); draw(); renderMeteorPanel();
}));

// Time scrubber
const scrub=document.getElementById('timeScrub'); const scrubLabel=document.getElementById('scrubLabel');
function updateScrubLabel(){
  const min=+scrub.min, max=+scrub.max, val=+scrub.value, pct=(val-min)/(max-min);
  const rect= scrub.getBoundingClientRect(); scrubLabel.style.left = (pct*rect.width)+'px';
  const s = val; const sign=s>=0?"+":"‚àí"; const as=Math.abs(s); const d=Math.floor(as/86400); const h=Math.floor((as%86400)/3600); const m=Math.floor((as%3600)/60);
  let txt=`${sign}`; if(d) txt+=`${d}d `; if(h||d) txt+=`${h}h `; txt+=`${m}m`; scrubLabel.textContent = txt.trim();
}
scrub.oninput=(e)=>{ offsetSeconds=parseInt(e.target.value,10); updateDeltaRead(); draw(); updateScrubLabel(); highlightMiniCalendar(); renderMeteorPanel(); };
window.addEventListener('resize', ()=>{ resize(); updateScrubLabel(); });

// Mini calendar (¬±5 days only; 11 buttons)
const miniCal=document.getElementById('miniCal'); const calInfo=document.getElementById('calInfo');
function startOfLocalDay(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
function renderMiniCalendar(){
  [...miniCal.querySelectorAll('.calbtn')].forEach(n=>n.remove());
  const baseLocal = new Date(baseTime.getTime());
  const baseMid = startOfLocalDay(baseLocal);
  const todayMid = startOfLocalDay(new Date());
  for(let i=-5;i<=5;i++){
    const day = new Date(baseMid.getTime() + i*86400000);
    const btn=document.createElement('button');
    btn.className='calbtn calbtn-'+i;
    btn.innerHTML = `<span class="dow">${day.toLocaleDateString(undefined,{weekday:'short'})}</span><span class="day">${day.getDate()}</span><span class="mon">${day.toLocaleDateString(undefined,{month:'short'})}</span>`;
    btn.onclick=()=>{ offsetSeconds = i*86400; clampScrub(); };
    if(day.getTime()===todayMid.getTime()) btn.classList.add('today');
    miniCal.insertBefore(btn, calInfo);
  }
  highlightMiniCalendar();
  calInfo.textContent = baseLocal.toLocaleDateString(undefined,{year:'numeric', month:'long'}) + ' ‚Ä¢ tap a day (¬±5d)';
}
function highlightMiniCalendar(){
  const dayIndex = Math.round(offsetSeconds/86400);
  [...miniCal.querySelectorAll('.calbtn')].forEach((b,idx)=>{
    const i = idx + (-5);
    if(i===dayIndex) b.classList.add('active'); else b.classList.remove('active');
  });
}
function clampScrub(){ const min=+scrub.min, max=+scrub.max; offsetSeconds = Math.max(min, Math.min(max, offsetSeconds)); scrub.value=offsetSeconds; updateDeltaRead(); draw(); updateScrubLabel(); highlightMiniCalendar(); renderMeteorPanel(); }

// Draw loop
function draw(){
  const t=currentTime(); const jd=jdFromDate(t); currentLST=lst(jd, lon);
  const LSThr=(mod(currentLST,2*Math.PI)*12/Math.PI); const h=Math.floor(LSThr), m=Math.floor((LSThr-h)*60);
  lstEl.textContent = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
  clockRead.textContent = `${String(t.getHours()).padStart(2,'0')}:${String(t.getMinutes()).padStart(2,'0')}:${String(t.getSeconds()).padStart(2,'0')}`;
  drawBackground(); drawGrid(); drawEcliptic(); drawStars(); drawConstellations(); drawDSOOnSky(); drawPlanets();
  octx.clearRect(0,0,ol.width,ol.height); drawLaunchTrajectory(); drawISSMarker(); drawRadiants();
}

// Init
function init(){
  baseTime = new Date(); setInputsFromBase(); updateDeltaRead();
  resize(); requestAnimationFrame(resize); requestAnimationFrame(()=>requestAnimationFrame(resize));
  window.addEventListener('resize', resize);
  renderMiniCalendar(); renderDSOList(); updateScrubLabel(); renderMeteorPanel(); draw();
  fetchLaunches(); loadISS();
}
document.getElementById('btnNow').addEventListener('click', ()=>{ baseTime=new Date(); offsetSeconds=0; setInputsFromBase(); scrub.value=0; updateDeltaRead(); draw(); renderMiniCalendar(); computeISSPasses(); renderMeteorPanel(); });
document.getElementById('btnGeo').addEventListener('click', ()=>{
  if(!navigator.geolocation){ toast("Geolocation not supported"); return; }
  navigator.geolocation.getCurrentPosition(p=>{
    document.getElementById('lat').value=p.coords.latitude.toFixed(6);
    document.getElementById('lon').value=p.coords.longitude.toFixed(6);
    const d=document.getElementById('date').value; const t=document.getElementById('time').value||"00:00:00";
    if(d){ const parts=d.split('-').map(Number); const tp=t.split(':').map(Number); baseTime=new Date(parts[0],parts[1]-1,parts[2],tp[0]||0,tp[1]||0,tp[2]||0||0); }
    lon=parseFloat(document.getElementById('lon').value)*DEG; lat=parseFloat(document.getElementById('lat').value)*DEG; draw(); computeISSPasses(); renderMeteorPanel();
  }, _=> toast("Couldn't get location"));
});
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
