<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pocket Planetarium ‚Äî v1.2 (Diagnostic)</title>
<style>
  :root{ --edge:#172744; --ink:#e6efff; --muted:#9bb0d7; }
  html,body{height:100%;margin:0;background:#06101c;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  #app{display:grid;grid-template-rows:64px 1fr 84px;grid-template-columns:320px 1fr;gap:10px;height:100%;padding:10px;box-sizing:border-box}
  header{grid-column:1/-1;display:flex;align-items:center;gap:8px}
  header h1{font-size:18px;margin:0 8px 0 0;font-weight:800}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:.2rem .5rem;border:1px solid #23416b;border-radius:999px;color:var(--muted);font-size:12px}
  #left{grid-row:2/4;grid-column:1;background:#0b1527;border:1px solid var(--edge);border-radius:12px;padding:10px;overflow:auto}
  #canvasWrap{grid-row:2;grid-column:2;position:relative;border-radius:12px;overflow:hidden;border:1px solid var(--edge);background:#02060d;min-height:520px}
  #sky{width:100%;height:100%;display:block;cursor:grab}
  #overlay{position:absolute;inset:0;pointer-events:none}
  #bottom{grid-row:3;grid-column:2;display:flex;align-items:center;gap:12px;background:#0b1527;border:1px solid var(--edge);border-radius:12px;padding:10px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:.35rem 0}
  .field{display:flex;flex-direction:column;gap:4px;min-width:136px}
  .field label{font-size:12px;color:var(--muted)}
  .field input,.field select{background:#0b1324;border:1px solid #1b2a47;color:var(--ink);border-radius:8px;padding:.45rem .6rem;font-size:14px;outline:none}
  .btn{background:#13213a;border:1px solid #1b2a47;color:var(--ink);padding:.48rem .72rem;border-radius:10px;font-weight:700;cursor:pointer}
  .note{font-size:12px;color:#9bb2da}
</style>
</head>
<body>
<div id="app">
  <header>
    <h1>üåå Pocket Planetarium</h1>
    <span class="pill">v1.2 Diagnostic</span>
    <span class="pill">W√óH <span id="wh">‚Äî</span></span>
    <span class="pill">JD <span id="jdRead">‚Äî</span></span>
  </header>

  <aside id="left">
    <h3>Where & When</h3>
    <div class="row">
      <div class="field"><label>Latitude (¬∞)</label><input id="lat" type="number" step="0.0001" value="33.422" /></div>
      <div class="field"><label>Longitude (¬∞)</label><input id="lon" type="number" step="0.0001" value="-111.822" /></div>
    </div>
    <div class="row">
      <div class="field"><label>Date</label><input id="date" type="date"/></div>
      <div class="field"><label>Time (local)</label><input id="time" type="time" step="1"/></div>
    </div>
    <div class="row">
      <button class="btn" id="btnNow">Now</button>
      <button class="btn" id="btnGeo">Use My Location</button>
      <button class="btn" id="btnTest">Force Draw Test</button>
    </div>
    <div class="row">
      <label><input id="grid" type="checkbox" checked/> Grid</label>
      <label><input id="ecliptic" type="checkbox" checked/> Ecliptic</label>
      <label><input id="planets" type="checkbox" checked/> Planets</label>
      <label><input id="dso" type="checkbox" checked/> DSOs</label>
    </div>
    <p class="note">If you see a big white crosshair & ‚ÄúHELLO SKY‚Äù text in the canvas, rendering works.</p>
  </aside>

  <div id="canvasWrap">
    <canvas id="sky"></canvas>
    <canvas id="overlay"></canvas>
  </div>

  <div id="bottom">
    <button class="btn" id="resetView">Reset View</button>
    <span class="note" id="status">status: ‚Äî</span>
  </div>
</div>

<script>
const DEG=Math.PI/180,RAD=180/Math.PI; const clamp=(x,a,b)=>Math.max(a,Math.min(b,x)); const mod=(x,m)=>((x%m)+m)%m;
function jdFromDate(d){return Date.UTC(d.getUTCFullYear(),d.getUTCMonth(),d.getUTCDate(),d.getUTCHours(),d.getUTCMinutes(),d.getUTCSeconds())/86400000+2440587.5;}
function gmst(jd){const T=(jd-2451545)/36525; let s=67310.54841+(876600*3600+8640184.812866)*T+0.093104*T*T-6.2e-6*T*T*T; return mod(s,86400)/240*DEG;}
function lst(jd,lon){return mod(gmst(jd)+lon,2*Math.PI);}
function azAltFromRADec(ra,dec,lat,L){const H=mod(L-ra,2*Math.PI);const s=Math.sin(dec)*Math.sin(lat)+Math.cos(dec)*Math.cos(lat)*Math.cos(H);const alt=Math.asin(clamp(s,-1,1));const c=(Math.sin(dec)-Math.sin(alt)*Math.sin(lat))/(Math.cos(alt)*Math.cos(lat));let az=Math.acos(clamp(c,-1,1)); if(Math.sin(H)>0) az=2*Math.PI-az; return {az,alt};}

const sky=document.getElementById('sky'), ol=document.getElementById('overlay'), wrap=document.getElementById('canvasWrap');
const ctx=sky.getContext('2d'), octx=ol.getContext('2d');
let W=0,H=0,R=0,scale=1,fov=180*DEG, yaw=0,pitch=0; let lat=33.422*DEG, lon=-111.822*DEG; let time=new Date();
let showGrid=true, showEcliptic=true, showDSO=true, showPlanets=true;
let currentJD=0,currentLST=0;

function resize(){
  const dpr=Math.max(1,Math.min(2,window.devicePixelRatio||1));
  W=Math.max(1,wrap.clientWidth); H=Math.max(1,wrap.clientHeight); if(H<100){H=520; wrap.style.minHeight='520px';}
  R=Math.min(W,H)/2;
  sky.width=W*dpr; sky.height=H*dpr; ol.width=W*dpr; ol.height=H*dpr;
  sky.style.width=W+'px'; sky.style.height=H+'px'; ol.style.width=W+'px'; ol.style.height=H+'px';
  ctx.setTransform(dpr,0,0,dpr,0,0); octx.setTransform(dpr,0,0,dpr,0,0);
  document.getElementById('wh').textContent=W+'√ó'+H;
  draw(true);
}

function project(az,alt){
  const theta=(Math.PI/2-alt), maxTheta=fov/2;
  if(theta>maxTheta) return null;
  const r=(theta/maxTheta)*R*scale;
  let x=r*Math.sin(az+yaw), y=-r*Math.cos(az+yaw);
  return {x:W/2+x, y:H/2+y, r};
}

function drawBackground(showHello){
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle='#021227'; ctx.fillRect(0,0,W,H);
  // horizon circle
  ctx.strokeStyle='#2a4e88'; ctx.lineWidth=2;
  ctx.beginPath(); ctx.arc(W/2,H/2,R*scale,0,2*Math.PI); ctx.stroke();
  // big crosshair + ‚ÄúHELLO SKY‚Äù to prove render
  ctx.strokeStyle='#ffffff'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(W/2-30,H/2); ctx.lineTo(W/2+30,H/2); ctx.moveTo(W/2,H/2-30); ctx.lineTo(W/2,H/2+30); ctx.stroke();
  if(showHello){ ctx.fillStyle='#ffffff'; ctx.font='bold 18px system-ui'; ctx.fillText('HELLO SKY', W/2-60, H/2-40); }
}

function drawGrid(){
  if(!showGrid) return;
  ctx.strokeStyle='#20406f'; ctx.setLineDash([4,6]); ctx.lineWidth=1;
  ctx.beginPath();
  for(let alt=75*DEG; alt>0; alt-=15*DEG){
    const r=( (Math.PI/2 - alt) / (fov/2) ) * R * scale;
    ctx.moveTo(W/2+r,H/2); ctx.arc(W/2,H/2,r,0,2*Math.PI);
  }
  ctx.stroke(); ctx.setLineDash([]);
}

function drawStars(){
  // Guaranteed visible sample stars regardless of math: eight compass points
  ctx.fillStyle='#d8e7ff';
  for(let a=0;a<8;a++){
    const az=a*Math.PI/4;
    const p=project(az, 45*DEG); if(p){ ctx.beginPath(); ctx.arc(p.x,p.y,3,0,2*Math.PI); ctx.fill(); }
  }
}

function draw(){
  currentJD=jdFromDate(time); currentLST=lst(currentJD,lon);
  document.getElementById('jdRead').textContent=currentJD.toFixed(2);
  drawBackground(true);
  drawGrid();
  drawStars(); // use demo stars so we always see something
  // show debug text
  ctx.fillStyle='#9bb2da'; ctx.font='12px system-ui';
  ctx.fillText('Debug: W='+W+' H='+H+' R='+R.toFixed(1), 12, 20);
  ctx.fillText('LST='+currentLST.toFixed(3)+' rad', 12, 36);
  ctx.fillText('Lat='+ (lat*RAD).toFixed(2)+'¬∞ Lon='+ (lon*RAD).toFixed(2)+'¬∞', 12, 52);
}

function setNow(){
  time=new Date();
  const d=document.getElementById('date'), t=document.getElementById('time'); const pad=n=>n.toString().padStart(2,'0');
  d.value=`${time.getFullYear()}-${pad(time.getMonth()+1)}-${pad(time.getDate())}`;
  t.value=`${pad(time.getHours())}:${pad(time.getMinutes())}:${pad(time.getSeconds())}`;
}

document.getElementById('btnNow').onclick=()=>{ setNow(); draw(); };
document.getElementById('btnGeo').onclick=()=>{
  if(!navigator.geolocation){ document.getElementById('status').textContent='status: no geolocation'; return; }
  navigator.geolocation.getCurrentPosition(p=>{
    document.getElementById('lat').value=p.coords.latitude.toFixed(6);
    document.getElementById('lon').value=p.coords.longitude.toFixed(6);
    lat=parseFloat(p.coords.latitude)*DEG; lon=parseFloat(p.coords.longitude)*DEG; draw();
    document.getElementById('status').textContent='status: location set';
  }, _=> document.getElementById('status').textContent='status: geolocation denied');
};
document.getElementById('btnTest').onclick=()=>{ draw(true); };

document.getElementById('grid').onchange=e=>{ showGrid=e.target.checked; draw(); };
document.getElementById('ecliptic').onchange=e=>{ showEcliptic=e.target.checked; draw(); };
document.getElementById('planets').onchange=e=>{ showPlanets=e.target.checked; draw(); };
document.getElementById('dso').onchange=e=>{ showDSO=e.target.checked; draw(); };
document.getElementById('resetView').onclick=()=>{ yaw=0; pitch=0; scale=1; resize(); };

function init(){
  setNow();
  // double RAF to ensure layout settled
  requestAnimationFrame(()=>requestAnimationFrame(()=>{
    resize();
    if('ResizeObserver' in window){
      new ResizeObserver(resize).observe(wrap);
    } else {
      window.addEventListener('resize', resize);
    }
  }));
}
init();
</script>
</body>
</html>
